{"ast":null,"code":"import _objectSpread from\"C:/Users/\\u05DE\\u05DC\\u05D0\\u05DA \\u05D2\\u05DC/Desktop/Projects/Instagram-master/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"C:/Users/\\u05DE\\u05DC\\u05D0\\u05DA \\u05D2\\u05DC/Desktop/Projects/Instagram-master/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"C:/Users/\\u05DE\\u05DC\\u05D0\\u05DA \\u05D2\\u05DC/Desktop/Projects/Instagram-master/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/\\u05DE\\u05DC\\u05D0\\u05DA \\u05D2\\u05DC/Desktop/Projects/Instagram-master/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/\\u05DE\\u05DC\\u05D0\\u05DA \\u05D2\\u05DC/Desktop/Projects/Instagram-master/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from'react';import{Link}from'react-router-dom';import MoodIcon from'@material-ui/icons/Mood';import{Avatar,IconButton,CardHeader,Divider,TextField,InputAdornment,Button}from'@material-ui/core';import{makeStyles}from'@material-ui/core/styles';import LocationOnIcon from'@material-ui/icons/LocationOn';import queryString from'query-string';// Cloudinary\nimport{Image}from'cloudinary-react';// Css\nimport'./style.css';//Socket io\nimport io from'socket.io-client';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var socket;// material ui style\nvar useStyles=makeStyles(function(theme){return{likes:{color:\"#262626\",fontSize:'14px',fontWeight:'600'},AddCommenttextField:{flexBasis:280,margin:'20px 2px',width:'99%',padding:'1% 0%'}};});var ChatMessages=function ChatMessages(_ref){var user=_ref.user,location=_ref.location;var _useState=useState(''),_useState2=_slicedToArray(_useState,2),messages=_useState2[0],setMessages=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),name=_useState4[0],setName=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),message=_useState6[0],setMessage=_useState6[1];var messagesEndRef=useRef();var connectedUser=JSON.parse(localStorage.getItem('user'));var classes=useStyles();// Socket connection\nvar ENDPOINT='localhost:3001';var connectionOptions={\"force new connection\":true,\"reconnectionAttempts\":\"Infinity\",\"timeout\":10000,\"transports\":[\"websocket\"]};var scrollToBottom=function scrollToBottom(){var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:\"smooth\"});};var sendMessage=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:e.preventDefault();if(!message){_context.next=7;break;}socket.emit('sendMessage',{name:name,message:message},function(){return setMessage('');});_context.next=5;return fetch('/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({UserId:connectedUser.id,reciver_id:user.id,sender_id:connectedUser.id,content:message})});case 5:_context.next=7;return fetch('/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({UserId:user.id,reciver_id:user.id,sender_id:connectedUser.id,content:message})});case 7:case\"end\":return _context.stop();}}},_callee);}));return function sendMessage(_x){return _ref2.apply(this,arguments);};}();var sendLocation=function sendLocation(){if(!navigator.geolocation){return alert('Your broswer not supported geolocation');}navigator.geolocation.getCurrentPosition(function(position){socket.emit('sendLocation',{latitude:position.coords.latitude,longitude:position.coords.longitude,name:name},/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fetch('/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({UserId:connectedUser.id,reciver_id:user.id,sender_id:connectedUser.id,content:message})});case 2:_context2.next=4;return fetch('/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({UserId:user.id,reciver_id:user.id,sender_id:connectedUser.id,content:message})});case 4:case\"end\":return _context2.stop();}}},_callee2);})));});};useEffect(function(){socket=io(ENDPOINT,connectionOptions);socket.emit('join',{id:connectedUser.id});},[]);// Handle messages\nuseEffect(function(){socket.on('message',function(message){setMessages([].concat(_toConsumableArray(messages),[message]));setTimeout(function(){return scrollToBottom();},400);});socket.on('locationMessage',function(message){setMessages([].concat(_toConsumableArray(messages),[_objectSpread(_objectSpread({},message),{},{location:true})]));setMessage('');setTimeout(function(){return scrollToBottom();},400);});},[messages]);var getConversation=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var response,_yield$response$json,messages;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return fetch('/message/conversation',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({UserId:connectedUser.id,partnerId:user.id})});case 2:response=_context3.sent;_context3.next=5;return response.json();case 5:_yield$response$json=_context3.sent;messages=_yield$response$json.messages;setMessages(messages);case 8:case\"end\":return _context3.stop();}}},_callee3);}));return function getConversation(){return _ref4.apply(this,arguments);};}();useEffect(function(){setTimeout(function(){return scrollToBottom();},400);if(user){var _queryString$parse=queryString.parse(location.search),chatwith=_queryString$parse.chatwith;setName(chatwith);getConversation();}},[user]);return/*#__PURE__*/_jsxs(\"div\",{className:\"base-container\",children:[/*#__PURE__*/_jsxs(\"div\",{style:{position:'sticky',top:'0'},children:[/*#__PURE__*/_jsx(CardHeader,{avatar:/*#__PURE__*/_jsxs(Avatar,{style:{height:'56px',width:'56px'},children:[/*#__PURE__*/_jsx(Image,{cloudName:\"malachcloud\",publicId:user.profile,width:\"56\",height:\"56\",crop:\"scale\"}),\" \"]}),title:/*#__PURE__*/_jsx(Link,{to:\"/profile\",children:/*#__PURE__*/_jsx(\"span\",{className:classes.likes,children:user.username})}),subheader:\"Active 2 hours ago\"}),/*#__PURE__*/_jsx(Divider,{})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"messages_div\",children:[messages&&messages.map(function(message,i){return/*#__PURE__*/_jsx(\"div\",{className:message.sender_id===connectedUser.id?'my-text-div':'friend-text-div',children:/*#__PURE__*/_jsx(\"div\",{className:message.sender_id===connectedUser.id?'my-text-container':'friend-text-div',children:/*#__PURE__*/_jsx(\"div\",{className:message.sender_id===connectedUser.id?'my-text':'friend-text',children:message.location?/*#__PURE__*/_jsx(\"a\",{target:\"_blank\",rel:\"noreferrer\",href:message.content,children:\"My location\"}):message.content})})},i);}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsx(TextField,{onKeyPress:function onKeyPress(e){return e.key==='Enter'?sendMessage(e):null;},onChange:function onChange(e){return setMessage(e.target.value);},value:message,className:classes.AddCommenttextField,variant:\"outlined\",type:\"text\",label:\"Message\",InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsxs(IconButton,{children:[\" \",/*#__PURE__*/_jsx(MoodIcon,{})]})}),endAdornment:/*#__PURE__*/_jsxs(InputAdornment,{position:\"end\",children:[/*#__PURE__*/_jsxs(Button,{onClick:sendLocation,children:[\" \",/*#__PURE__*/_jsx(LocationOnIcon,{style:{padding:'0px'}}),\" \"]}),/*#__PURE__*/_jsx(Button,{onClick:function onClick(e){return sendMessage(e);},color:\"primary\",children:\"Send\"})]})}})]});};export default ChatMessages;","map":{"version":3,"sources":["C:/Users/מלאך גל/Desktop/Projects/Instagram-master/client/src/components/chat/ChatMessages.js"],"names":["React","useState","useEffect","useRef","Link","MoodIcon","Avatar","IconButton","CardHeader","Divider","TextField","InputAdornment","Button","makeStyles","LocationOnIcon","queryString","Image","io","socket","useStyles","theme","likes","color","fontSize","fontWeight","AddCommenttextField","flexBasis","margin","width","padding","ChatMessages","user","location","messages","setMessages","name","setName","message","setMessage","messagesEndRef","connectedUser","JSON","parse","localStorage","getItem","classes","ENDPOINT","connectionOptions","scrollToBottom","current","scrollIntoView","behavior","sendMessage","e","preventDefault","emit","fetch","method","headers","body","stringify","UserId","id","reciver_id","sender_id","content","sendLocation","navigator","geolocation","alert","getCurrentPosition","position","latitude","coords","longitude","on","setTimeout","getConversation","partnerId","response","json","search","chatwith","top","height","profile","username","map","i","key","target","value","startAdornment","endAdornment"],"mappings":"0gCAAA,MAAOA,CAAAA,KAAP,EAAgBC,QAAhB,CAA0BC,SAA1B,CAAqCC,MAArC,KAAmD,OAAnD,CACA,OAASC,IAAT,KAAqB,kBAArB,CACA,MAAOC,CAAAA,QAAP,KAAqB,yBAArB,CACA,OAASC,MAAT,CAAiBC,UAAjB,CAA6BC,UAA7B,CAAyCC,OAAzC,CAAkDC,SAAlD,CAA6DC,cAA7D,CAA6EC,MAA7E,KAA2F,mBAA3F,CACA,OAASC,UAAT,KAA2B,0BAA3B,CACA,MAAOC,CAAAA,cAAP,KAA2B,+BAA3B,CACA,MAAOC,CAAAA,WAAP,KAAwB,cAAxB,CACA;AACA,OAAQC,KAAR,KAAoB,kBAApB,CACA;AACA,MAAO,aAAP,CACA;AACA,MAAOC,CAAAA,EAAP,KAAe,kBAAf,C,wFACA,GAAIC,CAAAA,MAAJ,CAEA;AACA,GAAMC,CAAAA,SAAS,CAAGN,UAAU,CAAC,SAACO,KAAD,QAAY,CACrCC,KAAK,CAAE,CACLC,KAAK,CAAE,SADF,CAELC,QAAQ,CAAC,MAFJ,CAGLC,UAAU,CAAE,KAHP,CAD8B,CAMrCC,mBAAmB,CAAE,CACjBC,SAAS,CAAE,GADM,CAEjBC,MAAM,CAAE,UAFS,CAGjBC,KAAK,CAAC,KAHW,CAIjBC,OAAO,CAAC,OAJS,CANgB,CAAZ,EAAD,CAA5B,CAeA,GAAMC,CAAAA,YAAY,CAAG,QAAfA,CAAAA,YAAe,MAAwB,IAArBC,CAAAA,IAAqB,MAArBA,IAAqB,CAAfC,QAAe,MAAfA,QAAe,eACT/B,QAAQ,CAAC,EAAD,CADC,wCAClCgC,QADkC,eACxBC,WADwB,8BAEjBjC,QAAQ,CAAC,EAAD,CAFS,yCAElCkC,IAFkC,eAE5BC,OAF4B,8BAGXnC,QAAQ,CAAC,EAAD,CAHG,yCAGlCoC,OAHkC,eAGzBC,UAHyB,eAIzC,GAAMC,CAAAA,cAAc,CAAGpC,MAAM,EAA7B,CACA,GAAMqC,CAAAA,aAAa,CAAGC,IAAI,CAACC,KAAL,CAAWC,YAAY,CAACC,OAAb,CAAqB,MAArB,CAAX,CAAtB,CACA,GAAMC,CAAAA,OAAO,CAAG1B,SAAS,EAAzB,CAEA;AACA,GAAM2B,CAAAA,QAAQ,CAAG,gBAAjB,CACA,GAAMC,CAAAA,iBAAiB,CAAI,CACvB,uBAAyB,IADF,CAEvB,uBAAwB,UAFD,CAGvB,UAAY,KAHW,CAIvB,aAAe,CAAC,WAAD,CAJQ,CAA3B,CAOA,GAAMC,CAAAA,cAAc,CAAG,QAAjBA,CAAAA,cAAiB,EAAM,2BAC3B,uBAAAT,cAAc,CAACU,OAAf,sEAAwBC,cAAxB,CAAuC,CAAEC,QAAQ,CAAE,QAAZ,CAAvC,EACD,CAFD,CAIA,GAAMC,CAAAA,WAAW,2FAAG,iBAAOC,CAAP,kHAChBA,CAAC,CAACC,cAAF,GADgB,IAGbjB,OAHa,yBAIZnB,MAAM,CAACqC,IAAP,CAAY,aAAZ,CAA2B,CAAEpB,IAAI,CAAJA,IAAF,CAAOE,OAAO,CAAPA,OAAP,CAA3B,CAA6C,iBAAMC,CAAAA,UAAU,CAAC,EAAD,CAAhB,EAA7C,EAJY,sBAKNkB,CAAAA,KAAK,CAAC,UAAD,CAAa,CAAEC,MAAM,CAAE,MAAV,CAAkBC,OAAO,CAAE,CAAE,eAAe,kBAAjB,CAA3B,CACxBC,IAAI,CAAElB,IAAI,CAACmB,SAAL,CAAe,CAAEC,MAAM,CAAErB,aAAa,CAACsB,EAAxB,CAA4BC,UAAU,CAAChC,IAAI,CAAC+B,EAA5C,CAAgDE,SAAS,CAACxB,aAAa,CAACsB,EAAxE,CAA4EG,OAAO,CAAE5B,OAArF,CAAf,CADkB,CAAb,CALC,8BAQNmB,CAAAA,KAAK,CAAC,UAAD,CAAa,CAAEC,MAAM,CAAE,MAAV,CAAkBC,OAAO,CAAE,CAAE,eAAe,kBAAjB,CAA3B,CACxBC,IAAI,CAAElB,IAAI,CAACmB,SAAL,CAAe,CAAEC,MAAM,CAAE9B,IAAI,CAAC+B,EAAf,CAAmBC,UAAU,CAAChC,IAAI,CAAC+B,EAAnC,CAAuCE,SAAS,CAACxB,aAAa,CAACsB,EAA/D,CAAmEG,OAAO,CAAE5B,OAA5E,CAAf,CADkB,CAAb,CARC,uDAAH,kBAAXe,CAAAA,WAAW,6CAAjB,CAcA,GAAMc,CAAAA,YAAY,CAAI,QAAhBA,CAAAA,YAAgB,EAAM,CAC1B,GAAG,CAACC,SAAS,CAACC,WAAd,CAA2B,CACvB,MAAOC,CAAAA,KAAK,CAAC,wCAAD,CAAZ,CACH,CACDF,SAAS,CAACC,WAAV,CAAsBE,kBAAtB,CAAyC,SAAAC,QAAQ,CAAI,CACnDrD,MAAM,CAACqC,IAAP,CAAY,cAAZ,CAA4B,CAACiB,QAAQ,CAAED,QAAQ,CAACE,MAAT,CAAgBD,QAA3B,CAAqCE,SAAS,CAAEH,QAAQ,CAACE,MAAT,CAAgBC,SAAhE,CAA2EvC,IAAI,CAAJA,IAA3E,CAA5B,sEAA8G,+JACtGqB,CAAAA,KAAK,CAAC,UAAD,CAAa,CAAEC,MAAM,CAAE,MAAV,CAAkBC,OAAO,CAAE,CAAE,eAAe,kBAAjB,CAA3B,CACxBC,IAAI,CAAElB,IAAI,CAACmB,SAAL,CAAe,CAAEC,MAAM,CAAErB,aAAa,CAACsB,EAAxB,CAA4BC,UAAU,CAAChC,IAAI,CAAC+B,EAA5C,CAAgDE,SAAS,CAACxB,aAAa,CAACsB,EAAxE,CAA4EG,OAAO,CAAE5B,OAArF,CAAf,CADkB,CAAb,CADiG,+BAItGmB,CAAAA,KAAK,CAAC,UAAD,CAAa,CAAEC,MAAM,CAAE,MAAV,CAAkBC,OAAO,CAAE,CAAE,eAAe,kBAAjB,CAA3B,CACxBC,IAAI,CAAElB,IAAI,CAACmB,SAAL,CAAe,CAAEC,MAAM,CAAE9B,IAAI,CAAC+B,EAAf,CAAmBC,UAAU,CAAChC,IAAI,CAAC+B,EAAnC,CAAuCE,SAAS,CAACxB,aAAa,CAACsB,EAA/D,CAAmEG,OAAO,CAAE5B,OAA5E,CAAf,CADkB,CAAb,CAJiG,yDAA9G,IAQD,CATD,EAUD,CAdD,CAgBAnC,SAAS,CAAC,UAAM,CACZgB,MAAM,CAAGD,EAAE,CAAC6B,QAAD,CAAWC,iBAAX,CAAX,CACA7B,MAAM,CAACqC,IAAP,CAAY,MAAZ,CAAoB,CAAEO,EAAE,CAACtB,aAAa,CAACsB,EAAnB,CAApB,EACH,CAHQ,CAGN,EAHM,CAAT,CAKA;AACA5D,SAAS,CAAC,UAAM,CACdgB,MAAM,CAACyD,EAAP,CAAU,SAAV,CAAqB,SAACtC,OAAD,CAAa,CAClCH,WAAW,8BAAKD,QAAL,GAAeI,OAAf,GAAX,CACAuC,UAAU,CAAC,iBAAM5B,CAAAA,cAAc,EAApB,EAAD,CAAyB,GAAzB,CAAV,CACC,CAHD,EAIA9B,MAAM,CAACyD,EAAP,CAAU,iBAAV,CAA6B,SAACtC,OAAD,CAAa,CACxCH,WAAW,8BAAKD,QAAL,kCAAkBI,OAAlB,MAA0BL,QAAQ,CAAC,IAAnC,KAAX,CACAM,UAAU,CAAC,EAAD,CAAV,CACAsC,UAAU,CAAC,iBAAM5B,CAAAA,cAAc,EAApB,EAAD,CAAyB,GAAzB,CAAV,CACH,CAJC,EAKD,CAVQ,CAUN,CAACf,QAAD,CAVM,CAAT,CAaA,GAAM4C,CAAAA,eAAe,2FAAG,0MACGrB,CAAAA,KAAK,CAAC,uBAAD,CAA0B,CAClDC,MAAM,CAAE,MAD0C,CAElDC,OAAO,CAAE,CACL,eAAe,kBADV,CAFyC,CAKlDC,IAAI,CAAElB,IAAI,CAACmB,SAAL,CAAe,CAAEC,MAAM,CAACrB,aAAa,CAACsB,EAAvB,CAA2BgB,SAAS,CAAE/C,IAAI,CAAC+B,EAA3C,CAAf,CAL4C,CAA1B,CADR,QACdiB,QADc,uCAQSA,CAAAA,QAAQ,CAACC,IAAT,EART,4CAQV/C,QARU,sBAQVA,QARU,CASlBC,WAAW,CAACD,QAAD,CAAX,CATkB,wDAAH,kBAAf4C,CAAAA,eAAe,2CAArB,CAYA3E,SAAS,CAAC,UAAM,CAEd0E,UAAU,CAAC,iBAAM5B,CAAAA,cAAc,EAApB,EAAD,CAAyB,GAAzB,CAAV,CACE,GAAGjB,IAAH,CAAS,wBACchB,WAAW,CAAC2B,KAAZ,CAAkBV,QAAQ,CAACiD,MAA3B,CADd,CACCC,QADD,oBACCA,QADD,CAEP9C,OAAO,CAAC8C,QAAD,CAAP,CACAL,eAAe,GAChB,CACJ,CARQ,CAQN,CAAC9C,IAAD,CARM,CAAT,CAYA,mBAEO,aAAK,SAAS,CAAC,gBAAf,wBACA,aAAK,KAAK,CAAE,CAACwC,QAAQ,CAAE,QAAX,CAAsBY,GAAG,CAAE,GAA3B,CAAZ,wBACD,KAAC,UAAD,EAEE,MAAM,cAAG,MAAC,MAAD,EAAQ,KAAK,CAAE,CAACC,MAAM,CAAC,MAAR,CAAexD,KAAK,CAAC,MAArB,CAAf,wBAA6C,KAAC,KAAD,EAAO,SAAS,CAAC,aAAjB,CAA+B,QAAQ,CAAEG,IAAI,CAACsD,OAA9C,CAAuD,KAAK,CAAC,IAA7D,CAAkE,MAAM,CAAC,IAAzE,CAA8E,IAAI,CAAC,OAAnF,EAA7C,OAFX,CAGE,KAAK,cAAE,KAAC,IAAD,EAAM,EAAE,WAAR,uBAAsB,aAAM,SAAS,CAAExC,OAAO,CAACxB,KAAzB,UAAiCU,IAAI,CAACuD,QAAtC,EAAtB,EAHT,CAIE,SAAS,CAAC,oBAJZ,EADC,cAOD,KAAC,OAAD,IAPC,GADA,cAUH,aAAK,SAAS,CAAC,cAAf,WACIrD,QAAQ,EAAIA,QAAQ,CAACsD,GAAT,CAAa,SAAClD,OAAD,CAAUmD,CAAV,qBACrB,YAAa,SAAS,CAAEnD,OAAO,CAAC2B,SAAR,GAAsBxB,aAAa,CAACsB,EAApC,CAAyC,aAAzC,CAAyD,iBAAjF,uBACI,YAAK,SAAS,CAAEzB,OAAO,CAAC2B,SAAR,GAAsBxB,aAAa,CAACsB,EAApC,CAAyC,mBAAzC,CAA+D,iBAA/E,uBACI,YAAK,SAAS,CAAEzB,OAAO,CAAC2B,SAAR,GAAsBxB,aAAa,CAACsB,EAApC,CAAyC,SAAzC,CAAqD,aAArE,UACEzB,OAAO,CAACL,QAAR,cACD,UAAG,MAAM,CAAC,QAAV,CAAoB,GAAG,CAAC,YAAxB,CAAqC,IAAI,CAAEK,OAAO,CAAC4B,OAAnD,yBADC,CAGF5B,OAAO,CAAC4B,OAJR,EADJ,EADJ,EAAUuB,CAAV,CADqB,EAAb,CADhB,cAeG,YAAK,GAAG,CAAEjD,cAAV,EAfH,GAVG,cA6BA,KAAC,SAAD,EAAW,UAAU,CAAE,oBAAAc,CAAC,QAAIA,CAAAA,CAAC,CAACoC,GAAF,GAAS,OAAT,CAAmBrC,WAAW,CAACC,CAAD,CAA9B,CAAmC,IAAvC,EAAxB,CAAqE,QAAQ,CAAE,kBAACA,CAAD,QAAOf,CAAAA,UAAU,CAACe,CAAC,CAACqC,MAAF,CAASC,KAAV,CAAjB,EAA/E,CAAkH,KAAK,CAAEtD,OAAzH,CAAkI,SAAS,CAAEQ,OAAO,CAACpB,mBAArJ,CAA0K,OAAO,CAAC,UAAlL,CAA6L,IAAI,CAAC,MAAlM,CAAyM,KAAK,CAAC,SAA/M,CACD,UAAU,CAAE,CACVmE,cAAc,cACZ,KAAC,cAAD,EAAgB,QAAQ,CAAC,OAAzB,uBACE,MAAC,UAAD,6BAAa,KAAC,QAAD,IAAb,GADF,EAFQ,CAMVC,YAAY,cACV,MAAC,cAAD,EAAgB,QAAQ,CAAC,KAAzB,wBACC,MAAC,MAAD,EAAQ,OAAO,CAAG3B,YAAlB,4BAAkC,KAAC,cAAD,EAAgB,KAAK,CAAE,CAACrC,OAAO,CAAC,KAAT,CAAvB,EAAlC,OADD,cAEE,KAAC,MAAD,EAAS,OAAO,CAAE,iBAACwB,CAAD,QAAOD,CAAAA,WAAW,CAACC,CAAD,CAAlB,EAAlB,CAA0C,KAAK,CAAC,SAAhD,kBAFF,GAPQ,CADX,EA7BA,GAFP,CAkDH,CAhJD,CAkJA,cAAevB,CAAAA,YAAf","sourcesContent":["import React, { useState, useEffect, useRef } from 'react'\nimport { Link } from 'react-router-dom'\nimport MoodIcon from '@material-ui/icons/Mood';\nimport { Avatar, IconButton, CardHeader, Divider, TextField, InputAdornment, Button } from '@material-ui/core'\nimport { makeStyles } from '@material-ui/core/styles'\nimport LocationOnIcon from '@material-ui/icons/LocationOn';\nimport queryString from 'query-string'\n// Cloudinary\nimport {Image} from 'cloudinary-react';\n// Css\nimport './style.css'\n//Socket io\nimport io from 'socket.io-client'\nlet socket\n\n// material ui style\nconst useStyles = makeStyles((theme) => ({\n    likes: {\n      color: \"#262626\",\n      fontSize:'14px',\n      fontWeight: '600',\n    },\n    AddCommenttextField: {\n        flexBasis: 280,\n        margin: '20px 2px',\n        width:'99%',\n        padding:'1% 0%',\n     \n      },\n  }))\n\nconst ChatMessages = ({ user, location }) => {\n    const [messages, setMessages] = useState('')\n    const [name, setName] = useState('')\n    const [message, setMessage] = useState('')\n    const messagesEndRef = useRef()\n    const connectedUser = JSON.parse(localStorage.getItem('user'))\n    const classes = useStyles()\n    \n    // Socket connection\n    const ENDPOINT = 'localhost:3001'\n    const connectionOptions =  {\n        \"force new connection\" : true,\n        \"reconnectionAttempts\": \"Infinity\", \n        \"timeout\" : 10000,                  \n        \"transports\" : [\"websocket\"]\n    }\n\n    const scrollToBottom = () => {\n      messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\n    }\n\n    const sendMessage = async (e) => {\n        e.preventDefault()\n       \n        if(message) {\n            socket.emit('sendMessage', { name,message }, () => setMessage(''))    \n            await fetch('/message', { method: 'POST', headers: { 'Content-Type':'application/json' },\n            body: JSON.stringify({ UserId: connectedUser.id, reciver_id:user.id, sender_id:connectedUser.id, content: message })\n          })\n            await fetch('/message', { method: 'POST', headers: { 'Content-Type':'application/json' },\n            body: JSON.stringify({ UserId: user.id, reciver_id:user.id, sender_id:connectedUser.id, content: message })\n         })\n        }\n    }\n    \n    const sendLocation =  () => {\n      if(!navigator.geolocation) {\n          return alert('Your broswer not supported geolocation')\n      }\n      navigator.geolocation.getCurrentPosition(position => {\n        socket.emit('sendLocation', {latitude: position.coords.latitude, longitude: position.coords.longitude, name}, async () => {\n          await fetch('/message', { method: 'POST', headers: { 'Content-Type':'application/json' },\n          body: JSON.stringify({ UserId: connectedUser.id, reciver_id:user.id, sender_id:connectedUser.id, content: message })\n        })\n          await fetch('/message', { method: 'POST', headers: { 'Content-Type':'application/json' },\n          body: JSON.stringify({ UserId: user.id, reciver_id:user.id, sender_id:connectedUser.id, content: message })\n       })\n      })\n      })\n    }\n\n    useEffect(() => {\n        socket = io(ENDPOINT, connectionOptions)\n        socket.emit('join', { id:connectedUser.id } )\n    }, [])\n\n    // Handle messages\n    useEffect(() => {\n      socket.on('message', (message) => {\n      setMessages([...messages, message])\n      setTimeout(() => scrollToBottom(), 400)\n      })\n      socket.on('locationMessage', (message) => {\n        setMessages([...messages,{...message,location:true} ])\n        setMessage('')\n        setTimeout(() => scrollToBottom(), 400)\n    })\n    }, [messages])\n\n\n    const getConversation = async () => {\n        const response = await fetch('/message/conversation', { \n            method: 'POST',\n            headers: {\n                'Content-Type':'application/json'\n            },\n            body: JSON.stringify({ UserId:connectedUser.id, partnerId: user.id})\n          })\n          const { messages } = await response.json()\n          setMessages(messages)\n    }\n\n    useEffect(() => {\n    \n      setTimeout(() => scrollToBottom(), 400)\n        if(user) {\n          const { chatwith } = queryString.parse(location.search)\n          setName(chatwith)\n          getConversation()\n        }\n    }, [user])\n\n\n\n    return (\n        \n           <div className=\"base-container\">\n           <div style={{position: 'sticky',  top: '0'}}>\n          <CardHeader \n           \n            avatar={ <Avatar style={{height:'56px',width:'56px'}}><Image cloudName=\"malachcloud\" publicId={user.profile} width=\"56\" height=\"56\" crop=\"scale\" /> </Avatar>}\n            title={<Link to={`/profile`}><span className={classes.likes}>{user.username}</span></Link>}\n            subheader=\"Active 2 hours ago\"\n          />\n          <Divider />\n         </div>\n        <div className=\"messages_div\">\n           {messages && messages.map((message, i) => (\n                <div key={i} className={message.sender_id === connectedUser.id ? 'my-text-div' : 'friend-text-div'}>\n                    <div className={message.sender_id === connectedUser.id ? 'my-text-container' : 'friend-text-div'}>\n                        <div className={message.sender_id === connectedUser.id ? 'my-text' : 'friend-text'}>\n                        { message.location ?\n                         <a target=\"_blank\"  rel=\"noreferrer\" href={message.content}>My location</a>\n                        :\n                        message.content\n                        }\n                       \n                        </div>\n                    </div>\n                </div>\n           ))}\n           <div ref={messagesEndRef} />\n        </div>\n          \n   \n           <TextField onKeyPress={e => e.key ==='Enter' ? sendMessage(e): null} onChange={(e) => setMessage(e.target.value)} value={message} className={classes.AddCommenttextField} variant=\"outlined\" type=\"text\" label=\"Message\"\n          InputProps={{\n            startAdornment: (\n              <InputAdornment position=\"start\">\n                <IconButton> <MoodIcon/></IconButton>\n              </InputAdornment>\n            ),\n            endAdornment: (\n              <InputAdornment position=\"end\">\n               <Button onClick={ sendLocation }> <LocationOnIcon style={{padding:'0px'}}/> </Button>\n                <Button  onClick={(e) => sendMessage(e) } color=\"primary\">Send</Button>\n              </InputAdornment>\n            ),\n          }}/>\n   \n        \n        </div>\n      \n    )\n}\n\nexport default ChatMessages\n"]},"metadata":{},"sourceType":"module"}